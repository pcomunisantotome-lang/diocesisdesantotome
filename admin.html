<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="icon" href="https://firebasestorage.googleapis.com/v0/b/diocesisdesantotome.firebasestorage.app/o/LOGOS%2Flogo%20iglesia%20samaritana.png?alt=media&token=56fd32c1-bb7d-4537-83f7-ace6662ff768" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .ql-editor { min-height: 150px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }
        .image-preview-item.featured {
            border: 4px solid #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-slate-100">
    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <img src="https://firebasestorage.googleapis.com/v0/b/diocesisdesantotome.firebasestorage.app/o/LOGOS%2Flogo%20iglesia%20samaritana.png?alt=media&token=56fd32c1-bb7d-4537-83f7-ace6662ff768" alt="Logo Diócesis" class="h-16 mx-auto mb-4">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Acceso de Administrador</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Iniciar Sesión</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel (hidden by default) -->
    <div id="admin-panel" class="hidden">
        <div class="relative min-h-screen md:flex">
            <!-- Mobile Menu Backdrop -->
            <div id="mobile-menu-backdrop" class="bg-black/50 fixed inset-0 z-20 hidden md:hidden"></div>
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-white text-white w-64 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30 shadow-lg flex flex-col">
                <div class="p-4 border-b border-slate-200 flex items-center space-x-3">
                     <img src="https://firebasestorage.googleapis.com/v0/b/diocesisdesantotome.firebasestorage.app/o/LOGOS%2Flogo%20iglesia%20samaritana.png?alt=media&token=56fd32c1-bb7d-4537-83f7-ace6662ff768" alt="Logo" class="h-10">
                    <span class="text-slate-800 font-bold text-lg">Admin Panel</span>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2">
                    <a href="#" data-target="noticias" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m-4 3H9m-4 4h2m-4 4h2m4-8h2m-4 4h2m-4 4h2m4-8h2"></path></svg>
                        Noticias
                    </a>
                    <a href="#" data-target="guiones" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Guiones
                    </a>
                    <a href="#" data-target="categorias" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 8v5c0 .512.195 1.024.586 1.414l7 7a2 2 0 002.828 0l7-7a2 2 0 000-2.828l-7-7A2 2 0 0012 3H7z"></path></svg>
                        Categorías
                    </a>
                </nav>
                <div class="p-4 border-t border-slate-200">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-red-100 hover:text-red-600 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Cerrar Sesión
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Mobile Header -->
                <header class="md:hidden bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center space-x-2">
                        <img src="https://firebasestorage.googleapis.com/v0/b/diocesisdesantotome.firebasestorage.app/o/LOGOS%2Flogo%20iglesia%20samaritana.png?alt=media&token=56fd32c1-bb7d-4537-83f7-ace6662ff768" alt="Logo" class="h-8">
                        <span class="text-slate-800 font-bold">Admin Panel</span>
                    </div>
                    <button id="mobile-menu-btn" class="text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </header>

                <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
                    <div id="noticias-section" class="admin-section">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4" id="form-title">Agregar Nueva Noticia</h2>
                            <form id="news-form">
                                <input type="hidden" id="news-id">
                                <div class="mb-4">
                                    <label for="news-title" class="block text-gray-700">Título</label>
                                    <input type="text" id="news-title" class="w-full mt-2 p-2 border rounded-lg" required>
                                </div>
                                <div class="mb-4">
                                    <label for="news-category" class="block text-gray-700">Categoría</label>
                                    <select id="news-category" class="w-full mt-2 p-2 border rounded-lg bg-white" required></select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-gray-700">Contenido</label>
                                    <div id="editor" class="mt-2 bg-white"></div>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-gray-700">Imágenes (la primera será la destacada)</label>
                                    <input type="file" id="news-images" class="w-full mt-2 p-2 border rounded-lg" multiple accept="image/*">
                                    <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <button type="submit" id="save-news-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Guardar Noticia</button>
                                    <button type="button" id="cancel-edit-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 hidden">Cancelar Edición</button>
                                </div>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                            <h2 class="text-2xl font-bold mb-4">Noticias Existentes</h2>
                            <div id="existing-news" class="space-y-4"><p>Cargando noticias...</p></div>
                        </div>
                    </div>

                    <div id="guiones-section" class="admin-section hidden">
                         <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Gestionar Guiones Diocesanos</h2>
                            <form id="script-form" class="space-y-4">
                                <div>
                                    <label for="script-file" class="block text-gray-700">Archivo(s) (PDF, Word, etc.)</label>
                                    <input type="file" id="script-file" class="w-full mt-2 p-2 border rounded-lg" required multiple>
                                </div>
                                <button type="submit" id="save-script-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Subir Guion(es)</button>
                            </form>
                            <h3 class="text-xl font-bold mt-6 mb-4">Guiones Subidos</h3>
                            <div id="script-list" class="space-y-2"><p>Cargando guiones...</p></div>
                        </div>
                    </div>

                    <div id="categorias-section" class="admin-section hidden">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Gestionar Categorías</h2>
                            <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                                <input type="text" id="category-name" placeholder="Nombre de la nueva categoría" class="w-full p-2 border rounded-lg" required>
                                <input type="color" id="category-color" value="#4F46E5">
                                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Agregar</button>
                            </form>
                            <h3 class="text-xl font-bold mt-6 mb-4">Categorías Existentes</h3>
                            <div id="category-list" class="space-y-2"><p>Cargando categorías...</p></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="notification-container" class="fixed top-5 right-5 z-50"></div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- Import Swiper JS (solo necesario si no estaba ya importado) -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

      document.addEventListener('DOMContentLoaded', () => {

        const firebaseConfig = {
            apiKey: "AIzaSyCIC457rky1NFQCas3uWFfIDVRBHfdbEAQ",
            authDomain: "diocesisdesantotome.firebaseapp.com",
            projectId: "diocesisdesantotome",
            storageBucket: "diocesisdesantotome.firebasestorage.app",
            messagingSenderId: "313851932898",
            appId: "1:313851932898:web:0b7e65d0da8d09d762aebb"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: { toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'], ['clean']
            ]}
        });
        
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');

        const navLinks = document.querySelectorAll('.nav-link');
        const adminSections = document.querySelectorAll('.admin-section');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.dataset.target;
                navLinks.forEach(l => {
                    l.classList.remove('bg-blue-600', 'text-white');
                    l.classList.add('text-slate-600', 'hover:bg-slate-200');
                });
                link.classList.add('bg-blue-600', 'text-white');
                link.classList.remove('text-slate-600', 'hover:bg-slate-200');
                adminSections.forEach(section => {
                    section.id === `${targetId}-section` ? section.classList.remove('hidden') : section.classList.add('hidden');
                });
                sidebar.classList.add('-translate-x-full');
                mobileMenuBackdrop.classList.add('hidden');
            });
        });
        
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            mobileMenuBackdrop.classList.remove('hidden');
        });

        mobileMenuBackdrop.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            mobileMenuBackdrop.classList.add('hidden');
        });


        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const newsForm = document.getElementById('news-form');
        const existingNewsContainer = document.getElementById('existing-news');
        const imageInput = document.getElementById('news-images');
        const imagePreviewsContainer = document.getElementById('image-previews');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryListContainer = document.getElementById('category-list');
        const newsCategorySelect = document.getElementById('news-category');
        const scriptForm = document.getElementById('script-form');
        const scriptListContainer = document.getElementById('script-list');
        
        let imageFiles = [];

        const slugify = (text) => {
          const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
          const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
          const p = new RegExp(a.split('').join('|'), 'g')
          return text.toString().toLowerCase().replace(/\s+/g, '-').replace(p, c => b.charAt(a.indexOf(c))).replace(/&/g, '-and-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '').substring(0, 75);
        };
        
        function showNotification(message, isError = false) {
            const id = 'notif_' + Date.now();
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification p-4 rounded-lg shadow-lg mb-2 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white opacity-0 transform translate-x-10`;
            notification.textContent = message;
            document.getElementById('notification-container').appendChild(notification);
            setTimeout(() => { notification.classList.remove('opacity-0', 'translate-x-10'); }, 10);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadNews();
                loadCategories();
                loadScripts();
            } else {
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                .catch(error => showNotification(`Error al iniciar sesión: ${error.message}`, true));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        function renderImagePreviews() {
            imagePreviewsContainer.innerHTML = '';
            imageFiles.forEach((img, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = `relative group rounded-lg overflow-hidden image-preview-item ${img.isFeatured ? 'featured' : ''}`;
                const imageUrl = (typeof img.source === 'string') ? img.source : URL.createObjectURL(img.source);

                previewDiv.innerHTML = `
                    <img src="${imageUrl}" class="w-full h-32 object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="set-featured-btn" data-index="${index}" title="Marcar como destacada">
                            <svg class="w-6 h-6 ${img.isFeatured ? 'text-yellow-400' : 'text-white'}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        </button>
                        <button type="button" class="delete-img-btn bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center" data-index="${index}" title="Eliminar imagen">&times;</button>
                    </div>
                `;
                imagePreviewsContainer.appendChild(previewDiv);
            });

            document.querySelectorAll('.delete-img-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const index = parseInt(e.currentTarget.dataset.index);
                    imageFiles.splice(index, 1);
                    if (imageFiles.length > 0 && !imageFiles.some(f => f.isFeatured)) {
                        imageFiles[0].isFeatured = true;
                    }
                    renderImagePreviews();
                };
            });

            document.querySelectorAll('.set-featured-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const index = parseInt(e.currentTarget.dataset.index);
                    imageFiles.forEach((file, i) => file.isFeatured = (i === index));
                    renderImagePreviews();
                };
            });
        }
        
        imageInput.addEventListener('change', () => {
            imageFiles = Array.from(imageInput.files).map((file, index) => ({
                source: file,
                isFeatured: index === 0 
            }));
            renderImagePreviews();
        });

        async function loadCategories() {
            try {
                const querySnapshot = await getDocs(query(collection(db, "categories"), orderBy("name")));
                categoryListContainer.innerHTML = '';
                newsCategorySelect.innerHTML = '';

                if (querySnapshot.empty) {
                    categoryListContainer.innerHTML = '<p>No hay categorías creadas.</p>';
                }

                querySnapshot.forEach(doc => {
                    const category = doc.data();
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex justify-between items-center p-2 border rounded-lg';
                    categoryDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="block w-5 h-5 rounded-full" style="background-color: ${category.color || '#cccccc'};"></span>
                            <span>${category.name}</span>
                        </div>
                        <button class="delete-category-btn bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600" data-id="${doc.id}">Eliminar</button>
                    `;
                    categoryListContainer.appendChild(categoryDiv);

                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    option.dataset.color = category.color;
                    newsCategorySelect.appendChild(option);
                });
            } catch (error) {
                showNotification(`Error al cargar categorías: ${error.message}`, true);
            }
        }

        async function loadNews() {
            existingNewsContainer.innerHTML = '<p>Cargando noticias...</p>';
            try {
                const q = query(collection(db, "noticias"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                existingNewsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    existingNewsContainer.innerHTML = '<p>No hay noticias creadas.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const news = doc.data();
                    const newsDiv = document.createElement('div');
                    newsDiv.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border rounded-lg gap-2';
                    newsDiv.innerHTML = `
                        <span class="flex-1">${news.title}</span>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <button class="edit-btn bg-yellow-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-yellow-600" data-id="${doc.id}">Editar</button>
                            <button class="delete-btn bg-red-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-red-600" data-id="${doc.id}">Eliminar</button>
                        </div>`;
                    existingNewsContainer.appendChild(newsDiv);
                });
            } catch (error) {
                showNotification(`Error al cargar noticias: ${error.message}`, true);
            }
        }

        async function loadScripts() {
            scriptListContainer.innerHTML = '<p>Cargando guiones...</p>';
            try {
                const querySnapshot = await getDocs(query(collection(db, "scripts"), orderBy("createdAt", "desc")));
                scriptListContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    scriptListContainer.innerHTML = '<p>No hay guiones subidos.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const script = doc.data();
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border rounded-lg';
                    div.innerHTML = `<span>${script.title}</span><button class="delete-script-btn bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600" data-id="${doc.id}">Eliminar</button>`;
                    scriptListContainer.appendChild(div);
                });
            } catch (error) {
                showNotification(`Error al cargar guiones: ${error.message}`, true);
            }
        }

        scriptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = e.target['script-file'].files; // <-- Changed to 'files' (plural)
            if (!files || files.length === 0) { // <-- Updated check
                showNotification('Por favor, selecciona uno o más archivos.', true);
                return;
            }

            const saveBtn = document.getElementById('save-script-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Subiendo...';
            
            const uploadTasks = [];

            for (const file of files) {
                const title = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                const storageRef = ref(storage, `diocesan-scripts/${Date.now()}_${file.name}`);
                
                // Creamos una promesa para cada subida y guardado
                const uploadTask = async () => {
                    await uploadBytesResumable(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    await addDoc(collection(db, "scripts"), {
                        title,
                        downloadURL,
                        fileName: file.name,
                        createdAt: serverTimestamp()
                    });
                };
                uploadTasks.push(uploadTask());
            }

            try {
                // Esperamos a que todas las promesas de subida se completen
                await Promise.all(uploadTasks);
                
                showNotification(`¡${files.length} guion(es) subido(s) con éxito!`);
                scriptForm.reset();
                loadScripts();
            } catch (error) {
                showNotification(`Error al subir los guiones: ${error.message}`, true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Subir Guion(es)';
            }
        });

        scriptListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-script-btn')) {
                const scriptId = e.target.dataset.id;
                try {
                    const docRef = doc(db, "scripts", scriptId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const fileURL = docSnap.data().downloadURL;
                        if (fileURL) {
                            const fileRef = ref(storage, fileURL);
                            await deleteObject(fileRef);
                        }
                    }
                    await deleteDoc(docRef);
                    showNotification('Guion eliminado con éxito.');
                    loadScripts();
                } catch (error) {
                     showNotification(`Error al eliminar el guion: ${error.message}`, true);
                }
            }
        });

        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryNameInput = e.target['category-name'];
            const categoryColorInput = e.target['category-color'];
            const categoryName = categoryNameInput.value.trim();
            if (categoryName) {
                try {
                    await addDoc(collection(db, "categories"), { 
                        name: categoryName,
                        color: categoryColorInput.value
                    });
                    showNotification('Categoría agregada con éxito.');
                    addCategoryForm.reset();
                    categoryColorInput.value = "#4F46E5";
                    loadCategories();
                } catch (error) {
                    showNotification(`Error al agregar categoría: ${error.message}`, true);
                }
            }
        });

        categoryListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-category-btn')) {
                const categoryId = e.target.dataset.id;
                try {
                    await deleteDoc(doc(db, "categories", categoryId));
                    showNotification('Categoría eliminada con éxito.');
                    loadCategories();
                } catch (error) {
                    showNotification(`Error al eliminar categoría: ${error.message}`, true);
                }
            }
        });
        
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newsId = e.target['news-id'].value;
            const title = e.target['news-title'].value;
            const selectedOption = newsCategorySelect.options[newsCategorySelect.selectedIndex];
            const category = selectedOption.value;
            const categoryColor = selectedOption.dataset.color;
            const summary = quill.root.innerHTML;
            const saveBtn = document.getElementById('save-news-btn');
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Guardando...
            `;
            saveBtn.classList.add('inline-flex', 'items-center');

            try {
                const uploadPromises = imageFiles
                    .filter(img => typeof img.source !== 'string')
                    .map(img => {
                        const storageRef = ref(storage, `news-images/${Date.now()}_${img.source.name}`);
                        return uploadBytesResumable(storageRef, img.source).then(snapshot => getDownloadURL(snapshot.ref));
                    });

                const newImageUrls = await Promise.all(uploadPromises);
                let urlIndex = 0;
                const allImageUrls = imageFiles.map(img => (typeof img.source === 'string') ? img.source : newImageUrls[urlIndex++]);
                
                const featuredImageUrl = allImageUrls[imageFiles.findIndex(f => f.isFeatured)] || null;
                const galleryUrls = allImageUrls.filter(url => url !== featuredImageUrl);

                const newsData = {
                    title, category, categoryColor, summary,
                    featuredImageUrl, galleryUrls,
                    updatedAt: serverTimestamp(),
                };

                if (newsId) {
                    await updateDoc(doc(db, "noticias", newsId), newsData);
                    showNotification('¡Noticia actualizada con éxito!');
                } else {
                    newsData.createdAt = serverTimestamp();
                    let slug = slugify(title);
                    const docSnap = await getDoc(doc(db, "noticias", slug));
                    if (docSnap.exists()) { slug = `${slug}-${Date.now()}`; }
                    await setDoc(doc(db, "noticias", slug), newsData);
                    showNotification('¡Noticia creada con éxito!');
                }
                resetForm();
                loadNews();
            } catch (error) {
                showNotification(`Error al guardar la noticia: ${error.message}`, true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Guardar Noticia';
                saveBtn.classList.remove('inline-flex', 'items-center');
            }
        });
        
        function resetForm() {
            newsForm.reset();
            quill.setContents([]);
            imageFiles = [];
            renderImagePreviews();
            document.getElementById('news-id').value = '';
            document.getElementById('form-title').textContent = 'Agregar Nueva Noticia';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        existingNewsContainer.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            
            if (e.target.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(db, "noticias", id));
                if (docSnap.exists()) {
                    const news = docSnap.data();
                    document.getElementById('news-id').value = id;
                    document.getElementById('news-title').value = news.title;
                    document.getElementById('news-category').value = news.category || '';
                    quill.root.innerHTML = news.summary;
                    
                    const featured = news.featuredImageUrl;
                    const gallery = news.galleryUrls || [];
                    imageFiles = [featured, ...gallery].filter(Boolean).map(url => ({
                        source: url,
                        isFeatured: url === featured
                    }));
                    
                    renderImagePreviews();
                    document.getElementById('form-title').textContent = 'Editando Noticia';
                    document.getElementById('cancel-edit-btn').classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
            }

            if (e.target.classList.contains('delete-btn')) {
                try {
                    const docSnap = await getDoc(doc(db, "noticias", id));
                    if(docSnap.exists()){
                        const newsData = docSnap.data();
                        const imagesToDelete = [newsData.featuredImageUrl, ...(newsData.galleryUrls || [])].filter(Boolean);
                        const deletePromises = imagesToDelete.map(url => {
                            try { return deleteObject(ref(storage, url)); } 
                            catch (e) { console.log("Error deleting image: ", e); return Promise.resolve(); }
                        });
                        await Promise.all(deletePromises);
                    }
                    await deleteDoc(doc(db, "noticias", id));
                    showNotification('Noticia eliminada con éxito.');
                    loadNews();
                } catch (error) {
                    showNotification(`Error al eliminar la noticia: ${error.message}`, true);
                }
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);
      });
    </script>
</body>
</html>


