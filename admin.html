<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Pantalla de Login -->
    <div id="login-container" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700">Email</label>
                    <input type="email" id="email" class="w-full mt-2 p-2 border rounded-lg" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700">Contraseña</label>
                    <input type="password" id="password" class="w-full mt-2 p-2 border rounded-lg" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- Panel de Administración (oculto por defecto) -->
    <div id="admin-panel" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">Panel de Administración</h1>
            <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Cerrar Sesión</button>
        </header>
        
        <main class="container mx-auto p-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4" id="form-title">Agregar Nueva Noticia</h2>
                <form id="news-form">
                    <input type="hidden" id="news-id">
                    <div class="mb-4">
                        <label for="news-title" class="block text-gray-700">Título</label>
                        <input type="text" id="news-title" class="w-full mt-2 p-2 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="news-category" class="block text-gray-700">Categoría</label>
                        <select id="news-category" class="w-full mt-2 p-2 border rounded-lg bg-white" required>
                            <!-- Las categorías se cargarán dinámicamente aquí -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="news-summary" class="block text-gray-700">Contenido</label>
                        <div id="editor" class="mt-2 bg-white"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700">Imágenes (la primera será la destacada)</label>
                        <input type="file" id="news-images" class="w-full mt-2 p-2 border rounded-lg" multiple accept="image/*">
                        <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                    </div>
                    <div id="upload-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4 hidden">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button type="submit" id="save-news-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Guardar Noticia</button>
                        <button type="button" id="cancel-edit-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 hidden">Cancelar Edición</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                <h2 class="text-2xl font-bold mb-4">Noticias Existentes</h2>
                <div id="existing-news" class="space-y-4">
                    <p>Cargando noticias...</p>
                </div>
            </div>

            <!-- NEW: Sección para Gestionar Categorías -->
            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                <h2 class="text-2xl font-bold mb-4">Gestionar Categorías</h2>
                <form id="add-category-form" class="flex items-center space-x-2 mb-4">
                    <input type="text" id="category-name" placeholder="Nombre de la nueva categoría" class="w-full p-2 border rounded-lg" required>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Agregar Categoría</button>
                </form>
                <div id="category-list" class="space-y-2">
                    <p>Cargando categorías...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Contenedor de Notificaciones -->
    <div id="notification-container" class="fixed top-5 right-5 z-50"></div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIC457rky1NFQCas3uWFfIDVRBHfdbEAQ",
            authDomain: "diocesisdesantotome.firebaseapp.com",
            projectId: "diocesisdesantotome",
            storageBucket: "diocesisdesantotome.firebasestorage.app",
            messagingSenderId: "313851932898",
            appId: "1:313851932898:web:0b7e65d0da8d09d762aebb"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: { toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'], ['clean']
            ]}
        });

        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const newsForm = document.getElementById('news-form');
        const existingNewsContainer = document.getElementById('existing-news');
        const imageInput = document.getElementById('news-images');
        const imagePreviewsContainer = document.getElementById('image-previews');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryListContainer = document.getElementById('category-list');
        const newsCategorySelect = document.getElementById('news-category');
        
        let existingImageUrls = [];

        const slugify = (text) => {
          const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
          const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
          const p = new RegExp(a.split('').join('|'), 'g')
          return text.toString().toLowerCase().replace(/\s+/g, '-').replace(p, c => b.charAt(a.indexOf(c))).replace(/&/g, '-and-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '').substring(0, 75);
        };
        
        function showNotification(message, isError = false) {
            const id = 'notif_' + Date.now();
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification p-4 rounded-lg shadow-lg mb-2 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white opacity-0 transform translate-x-10`;
            notification.textContent = message;
            document.getElementById('notification-container').appendChild(notification);
            setTimeout(() => { notification.classList.remove('opacity-0', 'translate-x-10'); }, 10);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadNews();
                loadCategories();
            } else {
                loginContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                .catch(error => showNotification(`Error al iniciar sesión: ${error.message}`, true));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        imageInput.addEventListener('change', () => {
            imagePreviewsContainer.innerHTML = '';
            existingImageUrls = [];
            Array.from(imageInput.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    previewDiv.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs text-center p-1">${file.name}</span></div>`;
                    imagePreviewsContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        });

        async function loadCategories() {
            try {
                const querySnapshot = await getDocs(query(collection(db, "categories"), orderBy("name")));
                categoryListContainer.innerHTML = '';
                newsCategorySelect.innerHTML = '';

                if (querySnapshot.empty) {
                    categoryListContainer.innerHTML = '<p>No hay categorías creadas.</p>';
                }

                querySnapshot.forEach(doc => {
                    const category = doc.data();
                    
                    // Populate management list
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex justify-between items-center p-2 border rounded-lg';
                    categoryDiv.innerHTML = `<span>${category.name}</span><button class="delete-category-btn bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600" data-id="${doc.id}">Eliminar</button>`;
                    categoryListContainer.appendChild(categoryDiv);

                    // Populate form select dropdown
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    newsCategorySelect.appendChild(option);
                });
            } catch (error) {
                showNotification(`Error al cargar categorías: ${error.message}`, true);
                console.error("Error fetching categories:", error);
            }
        }

        async function loadNews() {
            existingNewsContainer.innerHTML = '<p>Cargando noticias...</p>';
            try {
                const q = query(collection(db, "noticias"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                existingNewsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    existingNewsContainer.innerHTML = '<p>No hay noticias creadas.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const news = doc.data();
                    const newsDiv = document.createElement('div');
                    newsDiv.className = 'flex justify-between items-center p-3 border rounded-lg';
                    newsDiv.innerHTML = `<span>${news.title}</span><div><button class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 mr-2" data-id="${doc.id}">Editar</button><button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600" data-id="${doc.id}">Eliminar</button></div>`;
                    existingNewsContainer.appendChild(newsDiv);
                });
            } catch (error) {
                showNotification(`Error al cargar noticias: ${error.message}`, true);
            }
        }

        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryNameInput = e.target['category-name'];
            const categoryName = categoryNameInput.value.trim();
            if (categoryName) {
                try {
                    await addDoc(collection(db, "categories"), { name: categoryName });
                    showNotification('Categoría agregada con éxito.');
                    categoryNameInput.value = '';
                    loadCategories();
                } catch (error) {
                    showNotification(`Error al agregar categoría: ${error.message}`, true);
                }
            }
        });

        categoryListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-category-btn')) {
                const categoryId = e.target.dataset.id;
                if (confirm('¿Estás seguro de que quieres eliminar esta categoría?')) {
                    try {
                        await deleteDoc(doc(db, "categories", categoryId));
                        showNotification('Categoría eliminada con éxito.');
                        loadCategories();
                    } catch (error) {
                        showNotification(`Error al eliminar categoría: ${error.message}`, true);
                    }
                }
            }
        });
        
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newsId = e.target['news-id'].value;
            const title = e.target['news-title'].value;
            const category = e.target['news-category'].value;
            const summary = quill.root.innerHTML;
            const files = e.target['news-images'].files;
            const saveBtn = document.getElementById('save-news-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            try {
                const uploadTasks = Array.from(files).map(file => {
                    const storageRef = ref(storage, `news-images/${Date.now()}_${file.name}`);
                    return uploadBytesResumable(storageRef, file);
                });
                const snapshots = await Promise.all(uploadTasks);
                const newImageUrls = await Promise.all(snapshots.map(s => getDownloadURL(s.ref)));
                const allImageUrls = [...newImageUrls, ...existingImageUrls];
                const newsData = {
                    title, category, summary,
                    featuredImageUrl: allImageUrls[0] || null,
                    galleryUrls: allImageUrls.slice(1) || [],
                    updatedAt: serverTimestamp(),
                };

                if (newsId) {
                    await updateDoc(doc(db, "noticias", newsId), newsData);
                    showNotification('¡Noticia actualizada con éxito!');
                } else {
                    newsData.createdAt = serverTimestamp();
                    let slug = slugify(title);
                    const docSnap = await getDoc(doc(db, "noticias", slug));
                    if (docSnap.exists()) { slug = `${slug}-${Date.now()}`; }
                    await setDoc(doc(db, "noticias", slug), newsData);
                    showNotification('¡Noticia creada con éxito!');
                }
                resetForm();
                loadNews();
            } catch (error) {
                showNotification(`Error al guardar la noticia: ${error.message}`, true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Noticia';
            }
        });
        
        function resetForm() {
            newsForm.reset();
            quill.setContents([]);
            imagePreviewsContainer.innerHTML = '';
            document.getElementById('news-id').value = '';
            document.getElementById('form-title').textContent = 'Agregar Nueva Noticia';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            existingImageUrls = [];
        }

        existingNewsContainer.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(db, "noticias", id));
                if (docSnap.exists()) {
                    const news = docSnap.data();
                    document.getElementById('news-id').value = id;
                    document.getElementById('news-title').value = news.title;
                    document.getElementById('news-category').value = news.category || '';
                    quill.root.innerHTML = news.summary;
                    existingImageUrls = [news.featuredImageUrl, ...(news.galleryUrls || [])].filter(Boolean);
                    imagePreviewsContainer.innerHTML = '';
                    existingImageUrls.forEach(url => {
                         const previewDiv = document.createElement('div');
                         previewDiv.innerHTML = `<img src="${url}" class="w-full h-32 object-cover rounded-lg">`;
                         imagePreviewsContainer.appendChild(previewDiv);
                    });
                    document.getElementById('form-title').textContent = 'Editando Noticia';
                    document.getElementById('cancel-edit-btn').classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
            }

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('¿Estás seguro de que quieres eliminar esta noticia?')) {
                    try {
                        const docSnap = await getDoc(doc(db, "noticias", id));
                        if(docSnap.exists()){
                            const newsData = docSnap.data();
                            const imagesToDelete = [newsData.featuredImageUrl, ...(newsData.galleryUrls || [])].filter(Boolean);
                            const deletePromises = imagesToDelete.map(url => {
                                try { return deleteObject(ref(storage, url)); } 
                                catch (e) { console.log("Error deleting image: ", e); return Promise.resolve(); }
                            });
                            await Promise.all(deletePromises);
                        }
                        await deleteDoc(doc(db, "noticias", id));
                        showNotification('Noticia eliminada con éxito.');
                        loadNews();
                    } catch (error) {
                        showNotification(`Error al eliminar la noticia: ${error.message}`, true);
                    }
                }
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);
    </script>
</body>
</html>
